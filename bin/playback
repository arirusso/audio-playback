#!/usr/bin/env ruby
$LOAD_PATH.unshift File.join(File.dirname(__FILE__), '..', 'lib')

#
# ## Usage
#
# `playback [filename] [options]`
#
# #### options:
#
# * *-l* Latency in seconds.  Defaults to use the default latency for the selected output device
#
# * *-b* Buffer size in bytes eg 2048.  Defaults to 4096
# 
# * *-c* Output audio to the given channel(s).  Eg `-c 0,1` will direct audio to channels 0 and 1.  Defaults to use all available channels
#
# * *-o* Output device id or name.  Defaults to the system default
#
# * *-v* Verbose
#
#

require "audio-playback"
require "audio-playback/commandline"
require "optparse"

def help(opts)
  puts(opts)
  exit
end

options = {}

parser = OptionParser.new do |opts|

  opts.banner = "Usage: playback [file] [options]"
  opts.separator ""
  opts.separator "Specific options:"

  AudioPlayback::Commandline::OPTIONS.each do |key, spec|
    opts.on(spec[:short], spec[:long], spec[:type], spec[:name]) do |value|
      if value.is_a?(TrueClass) && !spec[:when_true].nil?
        value = spec[:when_true]
      end
      options[key] = value
    end
  end

  opts.on_tail("-h", "--help", "Show this message") { help(opts) }

  opts.on_tail("--version", "Show version") do
    puts AudioPlayback::VERSION
    exit
  end

  help(opts) if ARGV.empty?
end

parser.parse!

playback = AudioPlayback.play(ARGV[0], options)
playback.block
