#!/usr/bin/env ruby
$LOAD_PATH.unshift File.join(File.dirname(__FILE__), '..', 'lib')

# ## Usage
#
# `playback [filename] [options]`
#
# #### options:
#
# * *-l* Latency in millis
#
# * *-b* Buffer size eg 2048
#
# * *-c* Number of channels.  Must be equal or less to the number of channels that the output supports.
#
# * *-d* Direct output to the given channel(s).  Eg `-d 0,1` will direct the audio to channels 0 and 1
#
# * *-o* output id or name
#
# * *-v* verbose
#
# #### example:
#
# `playback test/media/1-stereo-44100.wav -v -d 0`

require "audio-playback"
require "audio-playback/commandline"
require "optparse"

def help(opts)
  puts(opts)
  exit
end

options = {}

parser = OptionParser.new do |opts|

  opts.banner = "Usage: playback [file] [options]"
  opts.separator ""
  opts.separator "Specific options:"

  AudioPlayback::Commandline::OPTIONS.each do |key, spec|
    opts.on(spec[:short], spec[:long], spec[:type], spec[:name]) do |value|
      if value.is_a?(TrueClass) && !spec[:when_true].nil?
        value = spec[:when_true]
      end
      options[key] = value
    end
  end

  opts.on_tail("-h", "--help", "Show this message") { help(opts) }

  opts.on_tail("--version", "Show version") do
    puts AudioPlayback::VERSION
    exit
  end

  help(opts) if ARGV.empty?
end

parser.parse!

playback = AudioPlayback.play(ARGV[0], options)
playback.block
